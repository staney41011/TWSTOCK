name: Daily Stock Scan

on:
  schedule:
    - cron: '0 22 * * 1-5'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run Force Clean
      run: |
        # 建立強制清洗腳本
        cat <<EOF > force_clean.py
        import json, os, math, glob
        TARGET_FILE = "data.json"
        DATA_DIR = "data"
        def clean_nan(obj):
            if isinstance(obj, float):
                if math.isnan(obj) or math.isinf(obj): return None
                return obj
            elif isinstance(obj, dict):
                return {k: clean_nan(v) for k, v in obj.items()}
            elif isinstance(obj, list):
                return [clean_nan(v) for v in obj]
            return obj
        def main():
            print("Running Force Clean...")
            if os.path.exists(TARGET_FILE):
                with open(TARGET_FILE, 'r', encoding='utf-8') as f: data = json.load(f)
                with open(TARGET_FILE, 'w', encoding='utf-8') as f: json.dump(clean_nan(data), f, ensure_ascii=False, indent=2)
            if os.path.exists(DATA_DIR):
                for fp in glob.glob(os.path.join(DATA_DIR, "*.json")):
                    with open(fp, 'r', encoding='utf-8') as f: d = json.load(f)
                    with open(fp, 'w', encoding='utf-8') as f: json.dump(clean_nan(d), f, ensure_ascii=False, indent=2)
        if __name__ == "__main__": main()
        EOF
        
        python force_clean.py

    - name: Commit and Push changes
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git fetch origin main
        git reset --soft origin/main
        
        git add data.json data/
        
        git commit -m "Force clean NaN from all files [skip ci]" || exit 0
        git push origin main
