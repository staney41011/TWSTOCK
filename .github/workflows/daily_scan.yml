name: Daily Stock Scan

on:
  # 1. æ¯å¤©æ—©ä¸Š 06:00 (UTC+8) è‡ªå‹•åŸ·è¡Œ -> åªè·‘ main.py
  schedule:
    - cron: '0 22 * * 1-5'
  
  # 2. æ‰‹å‹•è§¸ç™¼ -> æä¾›é¸é …è®“æ‚¨æ±ºå®šè¦ä¸è¦è·‘ Backfill
  workflow_dispatch:
    inputs:
      run_backfill:
        description: 'âš ï¸ æ˜¯å¦è¦åŸ·è¡Œæ­·å²å›è£œ (Backfill)? (è€—æ™‚è¼ƒä¹…ï¼Œåƒ…åœ¨ä¿®æ”¹ç­–ç•¥å¾Œä½¿ç”¨)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run Strategy Script
      run: |
        # åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹å‹•è§¸ç™¼ä¸”å‹¾é¸äº† backfill
        if [ "${{ github.event.inputs.run_backfill }}" == "true" ]; then
            echo "ğŸš€ åµæ¸¬åˆ°å›è£œæŒ‡ä»¤ï¼šå•Ÿå‹• backfill.py ..."
            if [ -f "backfill.py" ]; then
                python backfill.py
            else
                echo "âŒ æ‰¾ä¸åˆ° backfill.pyï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³ã€‚"
                exit 1
            fi
        else
            echo "âš¡ åŸ·è¡Œæ¨™æº–æ¯æ—¥æƒæï¼šå•Ÿå‹• main.py ..."
            python main.py
        fi

    - name: Commit and Push changes
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git fetch origin main
        git reset --soft origin/main
        
        # åŠ å…¥æ‰€æœ‰å¯èƒ½çš„è®Šæ›´ (åŒ…å«æ–°ç”¢ç”Ÿçš„ json å’Œ python ä¿®æ”¹)
        git add .
        
        # æäº¤ (å¦‚æœæ²’è®Šæ›´å‰‡ç•¥é)
        git commit -m "Auto update stock data [skip ci]" || exit 0
        git push origin main
